# vagrant-docker

My custom vagrant development environment, allowing quick dev boxes to be created, based on folder(s) of code

After a couple of months running proxiBlue, I realised that I need to adapt my dev environment, and virtualize.
My want was simple:

* Create a folder, and place site code therein.
* Bring that up as a virtual machine.
* Try and make it generic enough to easily prototype test boxes or debug on client code base/database given.
* allow quick testing of coe in various PHP versions

So I looked at Vagrant, and since the Vagrant commands are simply just a ruby script, and adjusted to my needs.

Requirements
=============

1. Vagrant, latest is best. I use 1.8.1. Not tested on any others, but should work.
2. Docker. I use Linux (Manjaro), so installed via its package manager. I am on version 1.10.3, build 20f81dd
3. [virtualbox / vmware-workstation in place of docker] - these do work, in place of docker, but is not actively maintained, as I don't use them
4. https://github.com/tonistiigi/dnsdock (more later in setup)

Setup Environment
=================

This is as per docker usage. If you use anything other than docker, you are on your own ;)

One main issue with using docker to bring up client machines is ip address allocation.
Docker dynamically assigns ip's to the machines.
Since it was not ideal to use ip's in browser, I found a solution to overcome this issue:

https://github.com/tonistiigi/dnsdock

So basically, we will configure docker to use this dnsdock service as its main DNS server.
Dnsdock will be setup to use your normal DNS server as its fallback
Your machine will be set to use DNSdock as its first dns server.

So, every time docker starts a new box, it will report that box to DNSDock, and viola - you can use named addresses for your boxes.

Start dnsdock like this:

```
docker run -d -v /var/run/docker.sock:/var/run/docker.sock --restart always --name dnsdockmain -p 172.17.42.1:53:53/udp tonistiigi/dnsdock -domain=".local.com" -nameserver="8.8.8.8:53"
```

The IP 172.17.42.1 is my local host machine docker bridge interface. Usually called docker0

```
09:26 $ ifconfig
docker0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.17.42.1  netmask 255.255.0.0  broadcast 0.0.0.0
        inet6 fe80::42:f2ff:fe5a:f88b  prefixlen 64  scopeid 0x20<link>
        ether 02:42:f2:5a:f8:8b  txqueuelen 0  (Ethernet)
        RX packets 443825  bytes 263992938 (251.7 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 463292  bytes 185656093 (177.0 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

-domain=".local.com" = your lcoal domain used. The folder will become the hostname. so you end up with FOLDER.local.com as the url to use.
-nameserver="8.8.8.8:53" = the fallback dns to use. without this you will not be able to get any other dns lookups working

Next, setup your local machine to use the docker0 interface as its DNS server.
You need to adjust how depending on what OS your host is.

```
09:28 $ cat /etc/resolv.conf
# Generated by resolvconf
nameserver 172.17.42.1
```

and finally, you need to tell docker to use DNSdock
Again, you need to adjust per your host OS:

```
09:31 $ cat /etc/systemd/system/docker.service.d/docker.conf
[Service]
ExecStart=
ExecStart=/usr/bin/docker daemon --bip=172.17.42.1/16 --dns=172.17.42.1 -H tcp://127.0.0.1:4243 -H unix:///var/run/docker.sock
```

The important bits are: ```--bip=172.17.42.1/16 --dns=172.17.42.1```

Once done, you should be able to query DNSDock for any set entries:
In your browser :

```http://dnsdock.local.com/services```

at this point you'd see one entry for dnsdock itself:

```
[]},"f5cbde595e53187bd1ad65e01a62046035c769fbfcee2815008d7a1be47e366e":{"Name":"dnsdock","Image":"dnsdock","Ip":"172.17.0.1","Ttl":-1,"Aliases":[]}}
```


Quick Start Guide
=================

* Clone this repo
* cd into the cloned folder: ```cd vagrant-docker```
* cd into the ```machines``` folder: ```cd machines```
* create a new folder. This will be the web root folder with your site code.
* cd back to the base volder 'vagrabt-docker'. NOTE: for all vagrant commands, you need to be at this folder level.
* bring up the virtual box : ```vagrant --name=<FOLDER NAME> up```

you will now see the guest booting up. The initial boot may be the slowest as the docker host needs to be built.
subsequent up's thereafter will be a matter of seconds, as the guest is already build.
If you destroy the guest, it will restart from the initial pull/build.

* once built, you can ssh to the box with : ```vagrant --name=<FOLDER NAME> ssh```
* You will find mysql running using username root, password root
* You will find a fresh (blank) db called 'database'
* you can now import whatever db you need into the base database, and configure the source to use the db.

You can easily test the same codebase in different versions of PHP/MYSQL/APACHE etc by creating a symlink in the machines folder

example:

ln -s ./<FOLDER> ./<NEW_NAME>

you can then bring up a second box, using the linked source folder, but designate a different basebox (default is DEBAIN_8)

```vagrant --name=<NEW_NAME> --basebox=DEBAIN_7 up```

you will end with a box on the original folder (debain 8) and one on teh linked folder (debain 7) allowing you to quickly test
code in multiple PHP versions and environments.

Other custom switches:

* '--bindports' usage : --bindports=1 : this will bind the box to your lcoal host port 80/443 - allowing external access to the box.
* '--webserver' usage : --webserver=apache|php : this will invoke the noted webserver, default is apache, use PHP for php's internal webserver




